<!doctype html>
<html lang="en">
	<head>

  <check if="{{ @ENV=='PROD' }}">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id={{ trim(@GOOGLE_AD_ID) }}"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', '{{ trim(@GOOGLE_AD_ID) }}');
  </script>
  </check>

		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <check if="{{ @ENV == 'DEV' }}">
    <true>
      <base href="{{ @SCHEME.'://'.@HOST.':'.@PORT.@BASE.'/'.@UI }}">
    </true>
    <false>
      <base href="{{ @SCHEME.'://'.@HOST.@BASE.'/'.@UI }}">
    </false>
  </check>

		<!-- Bootstrap CSS -->
		<!--link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous" -->
    <link href="assets/css/bootstrap.css" rel="stylesheet">

		<title>Statuslight Online - Device</title>
	</head>
	<body>

		<div id="statusContainer" class="container vh-100">

        <div class="jumbotron" style="margin-bottom: 0rem; padding-bottom: 1rem;">
          <div class="row">
            <div class="col-lg-2">
              <img src="assets/img/wemos-led-shield-yellow_small2.png">
            </div>
            <div class="col-lg-10">
              <h1 class="display-3">Make your status visible!</h1>
              <p class="lead">Whith a little hacking you can have your own device that indicates your Teams/Google/Slack status. </p>
              <div class="row row-cols-4" align="center">
                <div class="col-1"></div>
                <div class="col-3">
                  <a id="teamsLoginDevice" href="#">
                    <img src="assets/img/teams_logo.png" width="50px">
                    <p><small>Login with Teams</small></p>
                  </a>
                </div>
                <div class="col-3">
                  <a id="slackLoginDevice" href="#">
                    <img src="assets/img/slack_logo.png" width="50px">
                    <p><small>Login with Slack</small></p>
                  </a>
                </div>
                <div class="col-3">
                  <a id="googleLoginDevice" href="#">
                    <img src="assets/img/google_calendar_logo.png" width="50px">
                    <p><small>Login with Google</small></p>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <h1>How it works?</h1>
        <p>You login with your Office 365, Google or Slack account and you to register your device(s). The service will then send updates to the device(s) as your status changes.</p>
        <ul>
        <li>For Teams we use the presence information (<a href="https://docs.microsoft.com/en-us/microsoftteams/presence-admins" target="_blank">https://docs.microsoft.com/en-us/microsoftteams/presence-admins</a>)
        <li>For Google we use the free/busy information of your primary calendar (<a href="https://developers.google.com/calendar/v3/reference/freebusy" target="_blank">https://developers.google.com/calendar/v3/reference/freebusy</a>)
        <li>For Slack we use the status text; we set you busy if the status is ‘In a meeting’ (<a href="https://api.slack.com/docs/presence-and-status" target="_blank">https://api.slack.com/docs/presence-and-status</a>)
        </ul>
        <p>Detailed user guide can be found here: <a href="">TODO: ADD LINK</a></p>

      <h1>Protocol</h1>
      <p>The service works with any device that is capable to talk MQTT. It can be an ESP2866/ESP32, an Arduino or a Raspberry Pi. We have a reference project with ESP2866 (<a href="https://github.com/plugdio/statuslight-device" target="_blank">https://github.com/plugdio/statuslight-device</a>)</p>
      <p>The protocol follows the Homie IoT convention (<a href="https://homieiot.github.io/" target="_blank">https://homieiot.github.io/</a>). There is a 'statuslight' node with 2 properties: status and statusdetail. The service publishes the information to these every minute.</p>
      <p>Your device doesn’t need to use the Homie framework or implement the full convention, it’s enough to subscribe to these topics.</p>
      <pre>
        SL / {your_device_id} / statuslight / status / set --> busy
        SL / {your_device_id} / statuslight / statusdetail / set --> Teams: Busy/In a meeting
      </pre>
      <p>The values for the status topic can be:</p>
      <ul>
        <li>free
        <li>busy
        <li>away
        <li>offline
        <li>unknown
        <li>error
      </ul>
      <p>For statusdetail we use extra details from the presence provider.</p>

		</div>


		<!-- Optional JavaScript -->
		<!-- jQuery first, then Popper.js, then Bootstrap JS -->
		<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

  <script type="text/javascript">

      var getJSON = function(url, tokenHeader, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        if (tokenHeader != null) {
          xhr.setRequestHeader("authorization", "Bearer " + tokenHeader);
        }
        xhr.responseType = 'json';
        xhr.onload = function() {
          var status = xhr.status;
          if (status === 200) {
//            if (xhr.response.success == true) {
              callback(null, xhr.response);
//            } else {
//              callback(xhr.response.message, xhr.response);
//            }
          } else {
            callback(status, xhr.response);
          }
        };
        xhr.send();
      };

      var getConfig = function() {
        console.log('Getting the config ... ');

        getJSON('{{ trim(@base_app_path) }}/config', null, function(err, data) {
          if (err !== null) {
            console.log('Something went wrong #1: ' + err);
          } else {
            if (data.success == true) {
              $('#teamsLogin').attr("href", data.result.teamsLoginUrl);
              $('#googleLogin').attr("href", data.result.googleLoginUrl);
              $('#slackLogin').attr("href", data.result.slackLoginUrl);

              $('#teamsLoginDevice').attr("href", data.result.teamsLoginUrlDevice);
              $('#googleLoginDevice').attr("href", data.result.googleLoginUrlDevice);
              $('#slackLoginDevice').attr("href", data.result.slackLoginUrlDevice);
            } else {
              console.log('Something went wrong #2: ' + data.message);
            }
          }
        });
      };

      getConfig();
  </script>


	</body>
</html>

